---
title: "MSDS6372 Project 2 - Osteoporosis in Women"
author: "Caroll Rodriguez, Rajat Chandna, Randall Hendrickson, Lokesh Maganti"
date: "August 18, 2018"
output: 
  pdf_document:
    toc: yes
  html_document:
    toc: yes
    keep_md: yes
---
<style type="text/css">

body, td {
   font-size: 16px;
}
code.r{
  font-size: 8px;
}
pre {
  font-size: 10px
}
/* code.r will control the font size for R code echoed from the code chunk, while pre will apply to any R results output from the code. */
</style>

```{r setup00, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
library(knitr)
library(kableExtra)

```
\newpage

## **Objective 1** - EDA and logistic regression model

TODO: remove below from project description
Display the ability to perform EDA and build a logistic regression model

•	Perform your logistic regression analysis and provide interpretation of the regression coefficients including hypothesis testing, and confidence intervals. For simplicity sake, you do not need to include interactions with this model. Comment on the  practical vs statistical significance of the deemed important factors..

Logistical Considerations.

•	Just like last time, this does not have to be extremely fancy in terms of the model building approach, let EDA, feature selection, and overall intuition guide you.

## Introduction

TODO:

## Data Description
<p>The data set provided is about predicting whether a woman with osteoporosis will have another bone fracture.  Of course getting a bone fracture is somewhat circumstantial, but with this disease every day life could trigger a break if the progression of the disease is strong.  

The dataset included a total of 14 variables: 3 ID variables which tell us the subject, doctor and physical location of each record, 4 continuous variables (BMI, Weight, Height, and Age), 6 categorical variables (PRIORFRAC, PREMENO, MOMFRAC, PREMEO, MOMFRAC, ARMASSIST, SMOKE, RATERISK), and the response (FRACTURE). We were unable to find a mapping the subjects with their location to understand the mix of countries represented.

We have 500 subjects in the dataset of which 33% of the subjects have/had fractures. 

Missing values were not detected in dataset. Special characters were removed from column headings.
What we know/don't know about the sample (500)


## Exploratory Analysis  

### Assumptions  
This is a prospective study which means it's a study over time of a group of similar individuals
who differ with respect to certain factors under a study and how these factors affect rates of a certain outcome
(Fracture vs No-Fracture) Linearity - Independence of errors - Based on SUB_ID(Subject ID) we confirm
each record is an independent sample. Multicollinearity - Weight and BMI are highly correlated but we will
remove one from the analysis.


```
GLOW dataset:

Variable Name Type   #Unique  

     SUB_ID  integer  500 - Identification Code (1 - n)  
    SITE_ID  integer    6 - Study Site (1 - 6)  
     PHY_ID  integer  127 - Physician ID code (128 unique codes)  
 PRIORFRAC*   factor    2 - History of Prior Fracture (1: No, 2: Yes)   
        AGE  integer   36 - Age at Enrollment (Years)  
     WEIGHT  numeric  128 - Weight at enrollment (Kilograms)  
     HEIGHT  integer   34 - Height at enrollment (Centimeters)  
        BMI  numeric  409 - Body Mass Index (Kg/m^2)  
   PREMENO*   factor    2 - Menopause before age 45 (1: No, 2: Yes)  
   MOMFRAC*   factor    2 - Mother had hip fracture (1: No, 2: Yes)  
 ARMASSIST*   factor    2 - Arms are needed to stand from a chair (1: No, 2: Yes)  
     SMOKE*   factor    2 - Former or current smoker (1: No, 2: Yes)  
  RATERISK*   factor    3 - Self-reported risk of fracture (1: Less, 2: Same, 3: Greater)    
  FRACSCORE  integer   12 - Fracture Risk Score (Composite Risk Score)  
  FRACTURE*   factor    2 - Any fracture in first year (1: No, 2: Yes)  
  
```
```{r, echo = FALSE, out.width="25%"}
myimages<-list.files("./eda_images/continuous", pattern = ".png", full.names = TRUE)
include_graphics(myimages)
```

#### Figure 1 - Boxplots for Continuous Variables AGE, BMI, HEIGHT, WEIGHT

In Figure 1, we see the boxplots for the continous variables AGE, WEIGHT, HEIGHT, BMI.  

```{r, echo = FALSE, out.width="25%"}
myimages<-list.files("./eda_images/continuous_visual", pattern = ".png", full.names = TRUE)
include_graphics(myimages)
```

#### Figure 2 - Correlation, and Density plots for Continuous Variables AGE, BMI, HEIGHT, WEIGHT

```{r, echo = FALSE, out.width="50%"}
myimages<-list.files("./eda_images/multivariate", pattern = ".png", full.names = TRUE)
include_graphics(myimages)
```

#### Figure 3 - Barplot (occurrances) and Multivariate Plots for Categorical and Continuous Variables 


```{r, echo = FALSE, out.width="50%"}
myimages<-list.files("./eda_images/scatterplots", pattern = ".png", full.names = TRUE)
include_graphics(myimages)
```

#### Figure 4 - Scatterplots 

```{r, echo = FALSE, out.width="25%"}
myimages<-list.files("./eda_images/roc_and_2way", pattern = ".png", full.names = TRUE)
include_graphics(myimages)
```

#### Figure 5 - ROC and 2-way Tables 

```{r, echo = FALSE, out.width="50%"}
myimages<-list.files("./eda_images/clustering", pattern = ".png", full.names = TRUE)
include_graphics(myimages)
```

#### Figure 6 - Clustering  



## Restatement of Problem and the overall approach to solve it.

TODO:

## Model Selection

TODO: add a description for the below selection

**Simple Logistic Model Fit:**  

```
Call:
glm(formula = FRACTURE ~ AGE + HEIGHT + PRIORFRAC + MOMFRAC + 
    ARMASSIST + RATERISK, family = binomial(link = "logit"), 
    data = trainingData)

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-1.5491  -0.7377  -0.5763   0.2298   2.2214  

Coefficients:
            Estimate Std. Error z value Pr(>|z|)   
(Intercept)  3.33365    3.80104   0.877  0.38047   
AGE          0.04347    0.01578   2.755  0.00587 **
HEIGHT      -0.04881    0.02165  -2.254  0.02418 * 
PRIORFRAC1   0.22281    0.30097   0.740  0.45912   
MOMFRAC1     0.33522    0.38263   0.876  0.38097   
ARMASSIST1   0.68418    0.27861   2.456  0.01406 * 
RATERISK.L   0.50762    0.24656   2.059  0.03951 * 
RATERISK.Q  -0.06727    0.22219  -0.303  0.76209 
```
**Model Equation**

$log(\pi)$ = 3.33365 +  0.04347 * AGE - 0.04881 * HEIGHT + 0.22281 * PRIORFRAC + 0.33522 * MOMFRAC    
                + 0.68418 * ARMASSIST + 0.50762 * RATERISK_2 - 0.06727 * RATERISK_3    

```
Coefficients and 95% Confidence Intervals converted to Normal Scale 
            ODDs_Ratio     2.5 %       97.5 %
(Intercept) 28.0403767 0.0172620 5.378401e+04
AGE          1.0444253 1.0128322 1.077662e+00
HEIGHT       0.9523628 0.9118527 9.929059e-01
PRIORFRAC1   1.2495774 0.6857875 2.237992e+00
MOMFRAC1     1.3982464 0.6449924 2.917750e+00
ARMASSIST1   1.9821443 1.1469582 3.428352e+00
RATERISK.L   1.6613370 1.0283916 2.713240e+00
RATERISK.Q   0.9349462 0.6060378 1.451499e+00

```

## Checking Assumptions

TODO: Lokesh please add assumptions

## *Interpretation of the Coefficients:*  


For AGE: All the other variables being constant, for every one-year increase in age of women, the odds of being getting a fracture in first year (versus not getting a fracture in first year) increases by a factor of 1.04(4% increase). The 95% Confidence Interval for this multiplicative factor is from 1.01(1% increase) to 1.08(8% increase).  

For HEIGHT: All the other variables being constant, for every one unit increase in height of women, the odds of being getting a fracture in first year (versus not getting a fracture in first year) decreases by a factor of 0.95(5% decrease). The 95% Confidence Interval for this multiplicative factor is from 0.91(9% decrease) to 0.99(1% decrease).  

** All the below coefficients are of format:
The estimated odds for Person X with/without characteristic are M times the odds (of developing fracture in first year), for another Person Y without/with that characteristic. **  

For PRIORFRAC: All the other variables being constant, the estimated odds for a woman, who has history of prior fracture, are 1.25 (25% more) times the odds of having fracture again in first year, for a woman who didn’t have prior history of fracture. The 95% Confidence Interval for this estimated odds ratio is from 0.69 times to 2.23 times.

For MOMFRAC: All the other variables being constant, the estimated odds for a woman, whose mother had hip fracture, are 1.40 (40% more) times the odds of having fracture in first year, for a woman whose mother didn’t have hip fracture. The 95% Confidence Interval for this estimated odds ratio is from 0.64 times to 2.91 times.

For ARMASSIST: All the other variables being constant, the estimated odds for a woman, who needed arms to stand from a chair, are 1.98 (98% more) times the odds of having fracture in first year, for a woman who didn’t need arms to stand from a chair. The 95% Confidence Interval for this estimated odds ratio is from 1.15 times to 3.43 times.

For RATERISK.2: All the other variables being constant, the estimated odds for a woman, who self-reported that her risk for developing fracture is same as others of the same age, are 1.66 (66% more) times the odds of having fracture in first year, for a woman who self-reported that her risk for developing fracture is less than others of the same age. The 95% Confidence Interval for this estimated odds ratio is from 1.03 times to 2.71 times.

For RATERISK.3: All the other variables being constant, the estimated odds for a woman, who self-reported that her risk for developing fracture is greater than others of the same age, are 0.93 (7% less) times the odds of having fracture in first year, for a woman who self-reported that her risk for developing fracture is less than others of the same age. The 95% Confidence Interval for this estimated odds ratio is from 0.61 times to 1.45 times.







## Final conclusions from the analysis of Objective 1



```
TODO:


take writeup from EDA and place here with reference to figures, etc

```




\newpage

## **Objective 2** - additional competing models

•	Record the predictive performance metrics from your simple, highly interpretable model from Objective 1.  


•	You must include one additional model which is also a more complicated logistic regression model than in Objective 1.  By complicated, I do not mean that you include more predictors (that will be somewhat sorted out in Objective 1), but rather model complexity through interaction terms, new variables created by the group, or transformations.

•	Create another competing model using just the continuous predictors and use LDA or QDA.

•	Use a nonparameteric model approach as a competing model.  Random forest for predictors that are both categorical and continuous or a k-nearest neighbors approach if just working with continuous predictors. 

•	Provide a summary table of the performance across the competing methods. Summarize the overall findings.  A really great report will also give insight as to why the “best” model won out.  This is where a thorough EDA will always help.

## Visualizations from Model Comparisions

```{r, echo = FALSE, out.width="50%"}
myimages<-list.files("./model_comparison_images/fracture_counts_cv", pattern = ".png", full.names = TRUE)
include_graphics(myimages)
```

#### Figure 7 - Fracture Counts  

```{r, echo = FALSE, out.width="33%"}
myimages<-list.files("./model_comparison_images/lr_assumptionscheck", pattern = ".png", full.names = TRUE)
include_graphics(myimages)
```

#### Figure 8 - Logistic Regression Assumptions Check  


```{r, echo = FALSE, out.width="25%"}
myimages<-list.files("./model_comparison_images/lr_normal", pattern = ".png", full.names = TRUE)
include_graphics(myimages)
```

#### Figure 9 - Logistic Regression Normal - Train, Test, Linear, Cooks  



```{r, echo = FALSE, out.width="25%"}
myimages<-list.files("./model_comparison_images/plotting_interactions", pattern = ".png", full.names = TRUE)
include_graphics(myimages)
```

#### Figure 10 - Logistic Regression - Interactions  


```{r, echo = FALSE, out.width="25%"}
myimages<-list.files("./model_comparison_images/random_forests", pattern = ".png", full.names = TRUE)
include_graphics(myimages)
```

#### Figure 11 - Logistic Regression - Random Forests  


```{r, echo = FALSE, out.width="25%"}
myimages<-list.files("./model_comparison_images/conditional_random_forests", pattern = ".png", full.names = TRUE)
include_graphics(myimages)
```

#### Figure 12 - Logistic Regression - Conditional Random Forests  

```{r, echo = FALSE, out.width="25%"}
myimages<-list.files("./model_comparison_images/LDA", pattern = ".png", full.names = TRUE)
include_graphics(myimages)
```

#### Figure 13 - LDA  


## End Visualizations from Model Comparison

## Record predictive performance from objective 1

## Another competing model (interaction terms)

## Another competing model (just continuous) LDA

## nonparametric model (random forest)

## another nonparametric model (conditional random forest)

## Summary table of performance

| Model                                                         | Predictors         | Accuracy | 95% CI         | Sensitivity | Specificity | AUC   |
|---------------------------------------------------------------|--------------------|----------|----------------|-------------|-------------|-------|
| Logistic Regression (logit)                                   | 7                  | 74.5%    | (66.7%, 81.3%) | 94.6%       | 13.5%       | 67.8% |
| Logistic Regression w/Interactions (logit)                    | 7 + 3 interactions | 75.2%    | (67.4%, 81.9%) | 92.9%       | 21.6%       | 72.2% |
| Random Forest*                                                | 10                 | 74.5%    | (66.7%, 81.3%) | 99.1%       | 0.0%        | 74.2% |
| *RF Lower Cutoff (decreasing the probability from 50% to 30%) | 10                 | 73.8%    | (66%, 80.7%)   | 91.1%       | 21.6%       |       |
| Conditional Random Forest                                     | 10                 | 75.2%    | (67.4%, 81.9%) | 94.6%       | 16.2%       | 69.3% |
| LDA                                                           | 4                  | 73.2%    | (65.3%, 80.1%) | 94.6%       | 8.1%        | 60.2% |


## Conclusion/Discussion

TODO:


## ***Appendix*** ==========================================  


## *** ***Appendix A:*** EDA - Analysis =======================  


```{r child = 'EDA.Rmd'}
```


## *** ***Appendix B:*** Model Comparison - Analysis ==========  


```{r child = 'ModelComparison.Rmd'}
```


## *** ***Appendix C:*** Test interaction - LDA ===============  


```{r child = 'test_interaction.Rmd'}
```

